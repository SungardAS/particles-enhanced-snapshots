---
ingressPorts:
  - 443
  - 80
ingressPortsSSH:
  - 22
privateIngressPorts:
  - 6442
  - 61614
  - 61616
publicSubnet:
  - 1
  - 2
healthCheck:
  Target: HTTPS:443/
  HealthyThreshold: 3
  UnhealthyThreshold: 7
  Interval: 30
  Timeout: 10
---

  {{parameter "key_name" logicalId="KeyName"}}
  {{parameter "image_id" "base" logicalId="ImageId"}}
  {{parameter "instance_type" logicalId="InstanceType"}}
  {{parameter "name_tag" logicalId="NameTag"}}
  {{parameter "volume" logicalId="VolumeSize"}}
  {{parameter "iops" logicalId="VolumeIOps"}}
  {{parameter "ssh_location" logicalId="SshLocation"}}
  {{parameter "role_select" logicalId="RoleSelect"}}
  {{parameter "bucket_name" logicalId="BucketName"}}
  {{parameter "cluster_name" logicalId="ClusterName"}}
  {{parameter "vpc_id" logicalId="VpcId" description="[required] VPC to create the cluster in."}}
  {{parameter "uuid" logicalId="UUID"}}

  {{parameter "m:core" "cidr_range"
    logicalId="VPCCIDR"
    allowedPattern="(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
    maxLength="18"
    minLength="9"
    description="VPC CIDR (use the choosen below)"
    constraintDescription="must be a valid CIDR range formatted as x.x.x.x/x"
  }}

  {{parameter "m:core" "base"
    type="String"
    logicalId="TemplateUrl"
    allowedPattern="https?://[a-z0-9]+"
    maxLength="100"
    minLength="10"
    description="The nested stack template URL for SSM documents"
    constraintDescription="must be a valid HTTP/HTTPS URL format https://s3.amazonaws.com/.../TemplateName.template"
  }}

  {{#each publicSubnet}}
    {{
      parameter "subnet_id"
      logicalId=(concat "PublicSubnet" this)
      description="[Required] Network for Elastic Load Balancer. Network defines region to operate in."
    }}
  {{/each}}

  {{parameter "m:core" "arn"
    description="[Required] Existing SSL Certificate ARN for Elastic Load Balancer"
    logicalId="SslCertificateArn"}}


  {{
    condition "defined_role"
    logicalId="DefinedRole"
    roleSelectLogicalId="RoleSelect"
  }}

  {{parameter "m:core" "cidr_range"
    logicalId="SourceCIDR"
    allowedPattern="(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
    maxLength="18"
    minLength="9"
    description="The IP address range that can be used to access the Enhanced Snapshots instances over HTTP(80) and HTTPS(443).For security considerations 0.0.0.0/0 is not recommended, please restrict to a smaller IP range.  x.x.x.x/x format "
    constraintDescription="must be a valid CIDR range formatted as x.x.x.x/x"
  }}

  {{resource 'instanceprofile' logicalId="InstanceProfileEsAdmin"
    roleSelectLogicalId="RoleSelect"
    definedRoleLogicalId="DefinedRole"
    retain="true"
  }}

  {{resource 'role' logicalId="EsAdmin"
    definedRoleLogicalId="DefinedRole"
    retain="true"
  }}

  {{resource 'managedpolicy_ha' logicalId="ManagedPolicy"
    definedRoleLogicalId="DefinedRole"
    clusterName=(ref "ClusterName")
    retain="true"
  }}

  {{set "m:core" "true_false" parameterLogicalId="CreateSecurityRules" default="true"}}

  {{#each ingressPortsSSH}}
    {{
      resource "m:core" "base"
      type="AWS::EC2::SecurityGroupIngress"
      condition="CreateSecurityRulesIsTrueCondition"
      logicalId=(concat "SecurityGroupIngress" this)
      properties=(
        partial "security_group_ingress_properties"
        cidrLogicalId="VPCCIDR"
        securityGroupId='{"Fn::GetAtt": ["SecurityGroup","GroupId"]}'
        fromPort=this
        toPort=this
      )
    }}
  {{/each}}

  {{#each ingressPorts}}
    {{
      resource "m:core" "base"
      type="AWS::EC2::SecurityGroupIngress"
      condition="CreateSecurityRulesIsTrueCondition"
      logicalId=(concat "SecurityGroupIngress" this)
      properties=(
        partial "security_group_ingress_properties"
        cidrLogicalId="VPCCIDR"
        securityGroupId='{"Fn::GetAtt": ["SecurityGroup","GroupId"]}'
        fromPort=this
        toPort=this
      )
    }}
  {{/each}}

  {{#each privateIngressPorts}}
    {{
      resource "m:core" "base"
      type="AWS::EC2::SecurityGroupIngress"
      logicalId=(concat "SecurityGroupIngress" this)
      properties=(
        partial "security_group_ingress_properties"
        cidrLogicalId="VPCCIDR"
        securityGroupId='{"Fn::GetAtt": ["SecurityGroup","GroupId"]}'
        fromPort=this
        toPort=this
      )
    }}
  {{/each}}

  {{#each ingressPortsSSH}}
    {{
      resource "m:core" "base"
      type="AWS::EC2::SecurityGroupIngress"
      condition="CreateSecurityRulesIsTrueCondition"
      logicalId=(concat "ELBSecurityGroupIngress" this)
      properties=(
        partial "security_group_ingress_properties"
        cidrLogicalId="SshLocation"
        securityGroupId='{"Fn::GetAtt": ["ELBSecurityGroup","GroupId"]}'
        fromPort=this
        toPort=this
      )
    }}
  {{/each}}

  {{#each ingressPorts}}
    {{
      resource "m:core" "base"
      type="AWS::EC2::SecurityGroupIngress"
      condition="CreateSecurityRulesIsTrueCondition"
      logicalId=(concat "ELBSecurityGroupIngress" this)
      properties=(
        partial "security_group_ingress_properties"
        cidrLogicalId="SourceCIDR"
        securityGroupId='{"Fn::GetAtt": ["ELBSecurityGroup","GroupId"]}'
        fromPort=this
        toPort=this
      )
    }}
  {{/each}}

  {{resource 'sns_topic'
    logicalId="SnsTopic"
    clusterNameLogicalId=(ref "ClusterName")
  }}

  {{
    resource "m:ec2" "load_balancer"
    logicalId="ElasticLoadBalancer"
    scheme='internet-facing'
    subnets='[ {"Ref": "PublicSubnet1"}, {"Ref": "PublicSubnet2"} ]'
    crossZone='true'
    loadBalancerName='{"Fn::Join": ["",[{"Ref": "ClusterName"},"-lb"]]}'
    lbCookieStickinessPolicy='[ {"PolicyName": "ESSELBPolicy"} ]'
    securityGroups='[ { "Ref": "ELBSecurityGroup" } ]'
    connectionSettings='{ "IdleTimeout": 600 }'
    listeners=(
      partial 'listener'
      policyNames="ESSELBPolicy"
      sslCertificateArnLogicalId=(ref "SslCertificateArn")
    )
  }}

  {{
    resource "stack"
    logicalId="ESS"
    templateUrl=(ref "TemplateUrl")
  }}

 {{set 'm:vpc' 'security_group/output_all' securityGroupLogicalId="SecurityGroup"}}
 {{set 'm:ec2' 'load_balancer/output_all'  loadBalancerLogicalId="ElasticLoadBalancer"}}
