{{#layout
  TemplateDescription=(partial 'template_description_ha')
}}{{
  condition "defined_ssh" logicalId="DefinedSsh"
  sshLocationLogicalId="SshLocation"
  }}

  {{ set "minimal_stack_ha" }}

  {{
    resource 'vpc'
    logicalId="VPC"
    vpcCidr="VPCCIDR"
  }}

  {{
    resource 'security_group'
    logicalId="SecurityGroup"
    nameTagLogicalId="NameTag"
    vpcId='{"Ref": "VPC"}'
  }}

  {{
    resource 'security_group'
    logicalId="PrivateSecurityGroup"
    nameTagLogicalId="NameTag"
    vpcId='{"Ref": "VPC"}'
  }}

  {{
    resource 'subnet'
    logicalId="PublicSubnet1"
    vpcLogicalId="VPC"
    cidrBlock='{ "Fn::Select" : ["0", { "Ref": "PublicSubnetIds" }]}'
    availabilityZone='{ "Fn::Select" : ["0", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } }]}'
  }}

  {{
    resource 'subnet'
    logicalId="PublicSubnet2"
    vpcLogicalId="VPC"
    cidrBlock='{ "Fn::Select" : ["1", { "Ref": "PublicSubnetIds" }]}'
    availabilityZone='{ "Fn::Select" : ["1", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } }]}'
  }}

  {{
    resource 'subnet'
    logicalId="PrivateSubnet1"
    vpcLogicalId="VPC"
    cidrBlock='{ "Fn::Select" : ["0", { "Ref": "PrivateSubnetIds" }]}'
    availabilityZone='{ "Fn::Select" : ["0", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } }]}'
  }}

  {{
    resource 'subnet'
    logicalId="PrivateSubnet2"
    vpcLogicalId="VPC"
    cidrBlock='{ "Fn::Select" : ["1", { "Ref": "PrivateSubnetIds" }]}'
    availabilityZone='{ "Fn::Select" : ["1", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } }]}'
  }}

  {{
    resource "m:core" "base"
    type="AWS::EC2::InternetGateway"
    logicalId="InternetGateway"
    properties='{}'
  }}

  {{
    resource 'vpcgatewayattachment'
    logicalId="GatewayToInternet"
    vpcLogicalId="VPC"
    internetGatewayLogicalId="InternetGateway"
  }}

  {{
    resource 'sns_topic'
    logicalId="SnsTopic"
    clusterNameLogicalId="ClusterName"
  }}

  {{
    resource 'launchconfiguration'
    logicalId="LaunchConfiguration"
    imageId='{ "Ref": "ImageId" }'
    keyNameLogicalId="KeyName"
    instanceTypeLogicalId="InstanceType"
    autoScalingGroupLogicalId="AutoScalingGroup"
    privateSecurityGroupLogicalId="PrivateSecurityGroup"
  }}

  {{
    resource 'elasticloadbalancer'
    logicalId="ElasticLoadBalancer"
    subnets='[ {"Ref": "PublicSubnet1"}, {"Ref": "PublicSubnet2"} ]'
    securityGroupLogicalId="SecurityGroup"
    sslCertificateArnLogicalId="SslCertificateArn"
    clusterNameLogicalId="ClusterName"
  }}

  {{
    resource 'autoscalinggroup'
    logicalId="AutoScalingGroup"
    elbLogicalId="ElasticLoadBalancer"
    vpcZoneIdentifier='[ {"Ref": "PrivateSubnet1"}, {"Ref": "PrivateSubnet2"} ]'
    launchConfigurationLogicalId="LaunchConfiguration"
    clusterNameLogicalId="ClusterName"
    clusterSize="1"
  }}
{{/layout}}
